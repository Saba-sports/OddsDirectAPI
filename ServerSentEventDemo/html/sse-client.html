<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="width=device-width, initial-scale=2" name="viewport" />
    <title>SERVER SENT EVENT DEMO</title>

    <style>
      table {
        border-collapse: collapse;
      }

      td,
      th {
        border: 2px solid rgb(0, 0, 0);
        padding: 5px;
        text-align: left;
        vertical-align: middle;
      }

      .popup-content {
        height: 91%;
        width: 101%;
        margin-top: 4%;
        margin-bottom: 4%;
        /*max-height: inherit;*/
        /*max-width: inherit;*/
        overflow-x: hidden;
        overflow-y: auto;
      }

      .popup {
        position: absolute;
        top: 51%;
        left: 51%;
        transform: translate(-49%, -50%);

        padding: 9px;
        z-index: 3;
        border: 4px solid #36ba89;
        background: #ffffff;
        overflow-y: hidden;
        height: 76%;
        width: 76%;
      }

      .x {
        position: absolute;
        top: 11px;
        right: 11px;
        background: red;
        color: white;
      }
    </style>

    <script src="js/lib/eventsource.min.js" type="text/javascript"></script>
  </head>
  <body>
    <div class="popup" id="event_json_popup" style="display: none">
      <button class="x" id="event_popup_close_btn">x</button>
      <h3 id="event_json_popup_title"></h3>
      <div class="popup-content" id="event_json_popup_content"></div>
    </div>
    <div class="popup" id="market_popup" style="display: none">
      <button id="market_popup_refresh_btn">REFRESH</button>
      <button disabled="disabled" id="market_popup_disconnect_btn">
        DISCONNECT
      </button>
      <button class="x" id="market_popup_close_btn">x</button>
      <div class="popup-content" id="market_popup_content"></div>
    </div>

    <div id="profile">
      <h1 style="text-align: center">SERVER SENT EVENT DEMO</h1>
      <br />
      <label for="r_e_vendor_id">vendor_id: </label>
      <input
              id="r_e_vendor_id"
              type="text"
      />
      <br />
      <label for="r_e_vendor_member_id">vendor_member_id: </label>
      <input
              id="r_e_vendor_member_id"
              type="text"
      />
      <br />
      Environment:
      <input
        checked
        id="r_e_staging"
        onclick="changeEnvironmentArea('r_e_staging')"
        type="radio"
      /><label for="r_e_staging">Staging</label>
      <input
        id="r_e_production"
        onclick="changeEnvironmentArea('r_e_production')"
        type="radio"
      /><label for="r_e_production">Production</label>
      <button id="get_token">GetToken</button>
      <input id="token" type="hidden" value="" />
      <span id="display_token"></span>
      <hr />
      Type:
      <input
        checked
        id="r_t_event"
        onclick="changeApiArea('r_t_event')"
        type="radio"
      /><label for="r_t_event">Event</label>
      <input
        id="r_t_market"
        onclick="changeApiArea('r_t_market')"
        type="radio"
      /><label for="r_t_market">Market</label>
      <input
        id="r_t_outright"
        onclick="changeApiArea('r_t_outright')"
        type="radio"
      /><label for="r_t_outright">Outright</label>
      <input
        id="r_t_sport"
        onclick="changeApiArea('r_t_sport')"
        type="radio"
      /><label for="r_t_sport">Sport</label>
      <input
        id="r_t_league"
        onclick="changeApiArea('r_t_league')"
        type="radio"
      /><label for="r_t_league">League</label>
      <br />
      <br />
    </div>
    <hr />
    <div id="Sse_Event">
      <label for="event_query_str">Polling GetEvents:</label>
      <input
        id="event_query_str"
        style="width: 70%"
        type="text"
        value="includeMarkets=none&language=en&query=$top=3&$filter=isLive and eventStatus eq 'running'"
      />
      <button id="event_query_btn">QUERY</button>
      <hr />
      <label for="sse_events_query">SSE GetEvents:</label>
      <input
        id="sse_events_query"
        style="width: 70%"
        type="text"
        value="includeMarkets=none&language=en&query=$top=50&$filter=isLive and eventStatus eq 'running'"
      />
      <button id="sse_events_subscribe_btn">SUBSCRIBE</button>
      <button disabled="disabled" id="sse_events_disconnect">DISCONNECT</button>
    </div>
    <div id="Sse_Market" style="display: none">
      <label for="market_query_str">Polling GetMarkets:</label>
      <input
        id="market_query_str"
        style="width: 70%"
        type="text"
        value="language=en&query=$top=3&$filter=betType eq 1"
      />
      <button id="markets_query_btn">QUERY</button>
      <hr />
      <label for="sse_markets_query">SSE GetMarkets:</label>
      <input
        id="sse_markets_query"
        style="width: 70%"
        type="text"
        value="language=en&query=$top=3&$filter=betType eq 1"
      />
      <button id="sse_markets_subscribe_btn">SUBSCRIBE</button>
      <button disabled="disabled" id="sse_markets_disconnect">
        DISCONNECT
      </button>
    </div>
    <div id="Sse_Outright" style="display: none">
      <label for="outright_query_str">Polling GetOutrights:</label>
      <input
        id="outright_query_str"
        style="width: 70%"
        type="text"
        value="language=en"
      />
      <button id="outright_query_btn">QUERY</button>
      <hr />
      <label for="sse_outrights_query">SSE GetOutrights:</label>
      <input
        id="sse_outrights_query"
        style="width: 70%"
        type="text"
        value="language=en"
      />
      <button id="sse_outrights_subscribe_btn">SUBSCRIBE</button>
      <button disabled="disabled" id="sse_outrights_disconnect">
        DISCONNECT
      </button>
    </div>
    <div id="Sse_Sport" style="display: none">
      <label for="sport_query_str">Polling GetSports:</label>
      <input
        id="sport_query_str"
        style="width: 70%"
        type="text"
        value="language=en"
      />
      <button id="sport_query_btn">QUERY</button>
      <hr />
      <label for="sse_sports_query">SSE GetSports:</label>
      <input
        id="sse_sports_query"
        style="width: 70%"
        type="text"
        value="language=en"
      />
      <button id="sse_sports_subscribe_btn">SUBSCRIBE</button>
      <button disabled="disabled" id="sse_sports_disconnect">DISCONNECT</button>
    </div>
    <div id="Sse_League" style="display: none">
      <label for="League_query_str">Polling GetLeagues:</label>
      <input
        id="league_query_str"
        style="width: 70%"
        type="text"
        value="language=en"
      />
      <button id="league_query_btn">QUERY</button>
      <hr />
      <label for="sse_leagues_query">SSE GetLeagues:</label>
      <input
        id="sse_leagues_query"
        style="width: 70%"
        type="text"
        value="language=en"
      />
      <button id="sse_leagues_subscribe_btn">SUBSCRIBE</button>
      <button disabled="disabled" id="sse_leagues_disconnect">
        DISCONNECT
      </button>
    </div>
    <hr />
    <table id="total_table" style="width: 20%"></table>
    <table id="table" style="width: 90%"></table>

    <script>
      // <editor-fold defaultstate="collapsed" desc="init">

      // init get events query
      document
        .getElementById("event_query_btn")
        .addEventListener("click", function () {
          refreshEvents();
        });
      document
        .getElementById("event_popup_close_btn")
        .addEventListener("click", function () {
          document.getElementById("event_json_popup").style.display = "none";
        });

      // init get markets query
      document
        .getElementById("markets_query_btn")
        .addEventListener("click", function () {
          refreshMarkets();
        });
      // init get outright query
      document
        .getElementById("outright_query_btn")
        .addEventListener("click", function () {
          refreshOutrights();
        });
      // init get sport query
      document
        .getElementById("sport_query_btn")
        .addEventListener("click", function () {
          refreshSports();
        });
      // init get league query
      document
        .getElementById("league_query_btn")
        .addEventListener("click", function () {
          refreshLeagues();
        });

      let CURRENT_MARKET_QUERY = null;

      document
        .getElementById("market_popup_refresh_btn")
        .addEventListener("click", function () {
          refreshEventMarkets(CURRENT_MARKET_QUERY);
        });
      document
        .getElementById("market_popup_close_btn")
        .addEventListener("click", function () {
          clearSource();
          document.getElementById("market_popup").style.display = "none";
        });
      document
        .getElementById("market_popup_disconnect_btn")
        .addEventListener("click", () => clearSource());

      // sse related
      let CURRENT_SOURCE = null;
      let CURRENT_STATE = null;

      //Sse Event Client
      document
        .getElementById("sse_events_subscribe_btn")
        .addEventListener("click", () => subscribeEvents());
      document
        .getElementById("sse_events_disconnect")
        .addEventListener("click", () => clearSource());

      function getEventQueryStr() {
        return document.getElementById("event_query_str").value;
      }

      function getEventSseQueryStr() {
        return document.getElementById("sse_events_query").value;
      }

      //Sse Market Client
      document
        .getElementById("sse_markets_subscribe_btn")
        .addEventListener("click", () => subscribeMarkets());
      document
        .getElementById("sse_markets_disconnect")
        .addEventListener("click", () => clearSource());

      function getMarketQueryStr() {
        return document.getElementById("market_query_str").value;
      }

      function getMarketSseQueryStr() {
        return document.getElementById("sse_markets_query").value;
      }

      //Sse Outright Client
      document
        .getElementById("sse_outrights_subscribe_btn")
        .addEventListener("click", () => subscribeOutrights());
      document
        .getElementById("sse_outrights_disconnect")
        .addEventListener("click", () => clearSource());

      function getOutrightQueryStr() {
        return document.getElementById("outright_query_str").value;
      }

      function getOutrightSseQueryStr() {
        return document.getElementById("sse_outrights_query").value;
      }

      //Sse Sport Client
      document
        .getElementById("sse_sports_subscribe_btn")
        .addEventListener("click", () => subscribeSports());
      document
        .getElementById("sse_sports_disconnect")
        .addEventListener("click", () => clearSource());

      function getSportQueryStr() {
        return document.getElementById("sport_query_str").value;
      }

      function getSportSseQueryStr() {
        return document.getElementById("sse_sports_query").value;
      }

      //Sse League Client
      document
        .getElementById("sse_leagues_subscribe_btn")
        .addEventListener("click", () => subscribeLeagues());
      document
        .getElementById("sse_leagues_disconnect")
        .addEventListener("click", () => clearSource());

      function getLeagueQueryStr() {
        return document.getElementById("league_query_str").value;
      }

      function getLeagueSseQueryStr() {
        return document.getElementById("sse_leagues_query").value;
      }

      document
        .getElementById("get_token")
        .addEventListener("click", () => getToken());

      function clearSource() {
        if (CURRENT_SOURCE !== null) {
          CURRENT_SOURCE.close();
          CURRENT_SOURCE = null;

          document.getElementById("sse_events_disconnect").disabled = true;
          document.getElementById(
            "market_popup_disconnect_btn"
          ).disabled = true;
          document.getElementById("sse_markets_disconnect").disabled = true;
          document.getElementById("sse_outrights_disconnect").disabled = true;
          document.getElementById("sse_sports_disconnect").disabled = true;
          document.getElementById("sse_leagues_disconnect").disabled = true;
        }
      }

      // </editor-fold>

      // <editor-fold defaultstate="collapsed" desc="events">
      async function refreshEvents() {
        let query = getEventQueryStr();
        let eventsResponse = await getEvents(query);
        displayEventSse(eventsResponse);
      }

      function subscribeEvents() {
        clearSource();

        // let url = `/stream/v1/GetEvents?${getEventSseQueryStr()}`;
        let token = document.getElementById("token").value;

        let url = `/sports/stream/v1/GetEvents?token=${token}`;
        if (getEventSseQueryStr() !== "") {
          url = `${url}&${getEventSseQueryStr()}`;
        }

        let u = createFullUrl(url);

        console.log(u);

        CURRENT_SOURCE = new EventSource(u);

        CURRENT_SOURCE.onmessage = mergeEventDiffs;

        document.getElementById("sse_events_disconnect").disabled = false;
      }

      function subscribeMarkets() {
        clearSource();

        let token = document.getElementById("token").value;
        let url = `/sports/stream/v1/GetMarkets?token=${token}`;
        if (getMarketSseQueryStr() !== "") {
          url = `${url}&${getMarketSseQueryStr()}`;
        }

        let u = createFullUrl(url);

        console.log(u);

        CURRENT_SOURCE = new EventSource(u);
        CURRENT_SOURCE.onmessage = mergeMarketDiffs;

        document.getElementById("sse_markets_disconnect").disabled = false;
      }

      function subscribeOutrights() {
        clearSource();

        let token = document.getElementById("token").value;
        let url = `/sports/stream/v1/GetOutrights?token=${token}`;
        if (getOutrightSseQueryStr() !== "") {
          url = `${url}&${getOutrightSseQueryStr()}`;
        }

        let u = createFullUrl(url);

        console.log(u);

        CURRENT_SOURCE = new EventSource(u);
        CURRENT_SOURCE.onmessage = mergeOutrightDiffs;

        document.getElementById("sse_outrights_disconnect").disabled = false;
      }

      function subscribeSports() {
        clearSource();

        let token = document.getElementById("token").value;
        let url = `/sports/stream/v1/GetSports?token=${token}`;
        if (getSportSseQueryStr() !== "") {
          url = `${url}&${getSportSseQueryStr()}`;
        }

        let u = createFullUrl(url);

        console.log(u);

        CURRENT_SOURCE = new EventSource(u);
        CURRENT_SOURCE.onmessage = mergeSportsDiffs;

        document.getElementById("sse_sports_disconnect").disabled = false;
      }

      function subscribeLeagues() {
        clearSource();

        let token = document.getElementById("token").value;

        let url = `/sports/stream/v1/GetLeagues?token=${token}`;
        if (getLeagueSseQueryStr() !== "") {
          url = `${url}&${getLeagueSseQueryStr()}`;
        }

        let u = createFullUrl(url);

        console.log(u);

        CURRENT_SOURCE = new EventSource(u);
        CURRENT_SOURCE.onmessage = mergeLeaguesDiffs;

        document.getElementById("sse_leagues_disconnect").disabled = false;
      }

      function displayEventSse(event) {
        let eventsTable = document.getElementById("table");
        eventsTable.innerText = "";
        eventsTable.append(createEventTableHeaders());
        event.events.forEach((e) => {
          let row = createEventRow(e, event.queryTime, event.responseTime);
          document.getElementById("table").append(row);
        });
        createTotalTable();
      }

      function createTotalTable() {
        let totalTable = document.getElementById("total_table");
        totalTable.innerText = "";
        let eventTotalTh = document.createElement("th");
        eventTotalTh.innerText = "Total";
        let headerTr = document.createElement("tr");
        headerTr.append(eventTotalTh);
        let totalTd = document.createElement("td");
        totalTd.innerText = document.getElementById("table").rows.length - 1;
        let rowTr = document.createElement("tr");
        rowTr.append(totalTd);
        totalTable.append(headerTr, rowTr);
      }

      function createEventTableHeaders() {
        let th1 = document.createElement("th");
        th1.innerText = "Info";
        let th2 = document.createElement("th");
        th2.innerText = "EventId";
        let th3 = document.createElement("th");
        th3.innerText = "Status";
        let th4 = document.createElement("th");
        th4.innerText = "GameInfo";
        let th5 = document.createElement("th");
        th5.innerText = "QueryTime";
        let th6 = document.createElement("th");
        th6.innerText = "ResponseTime";
        let th7 = document.createElement("th");
        th7.innerText = "Options";

        let tr = document.createElement("tr");
        tr.append(th1, th2, th3, th4, th5, th6, th7);
        return tr;
      }

      function createEventRow(e, queryTime, responseTime) {
        let info = document.createElement("td");

        info.innerText = `${e.sportName}\n${e.leagueName}\n(H)${e.teamInfo.homeName}\n(A)${e.teamInfo.awayName}\n${e.gameInfo.liveHomeScore} - ${e.gameInfo.liveAwayScore}\n${e.globalShowTime}`;
        info.style.textAlign = "center";

        let eventId = document.createElement("td");
        eventId.innerText = e.eventId;

        let status = document.createElement("td");
        status.innerText = e.eventStatus;

        let gameInfoPre = document.createElement("pre");
        gameInfoPre.innerText = JSON.stringify(e.gameInfo, null, 2);
        let gameInfo = document.createElement("td");
        gameInfo.append(gameInfoPre);

        let queryTimeInfo = document.createElement("td");
        queryTimeInfo.innerText = queryTime;

        let responseTimeInfo = document.createElement("td");
        responseTimeInfo.innerText = responseTime;

        let showRawJsonBtn = document.createElement("button");
        showRawJsonBtn.innerText = "Show Event Raw Json";

        showRawJsonBtn.addEventListener("click", function () {
          let popupContent = document.getElementById(
            "event_json_popup_content"
          );
          popupContent.innerHTML = "";
          document.getElementById(
            "event_json_popup_title"
          ).innerText = `Event ${e.eventId}`;
          let jsonPre = document.createElement("pre");
          jsonPre.innerText = JSON.stringify(e, null, 2);
          popupContent.append(jsonPre);
          document.getElementById("event_json_popup").style.display = "block";
        });

        let getMarketsBtn = document.createElement("button");
        getMarketsBtn.innerText = "GetMarkets";
        getMarketsBtn.addEventListener("click", async function () {
          let q = `query=$filter=eventId eq ${e.eventId} and marketStatus eq 'running'`;
          CURRENT_MARKET_QUERY = q;
          await refreshEventMarkets(q);
        });

        let subscribeMarketsBtn = document.createElement("button");
        subscribeMarketsBtn.innerText = "SubscribeMarkets";
        subscribeMarketsBtn.addEventListener("click", function () {
          let q = `language=en&query=$filter=eventId eq ${e.eventId} and marketStatus eq 'running'`;
          CURRENT_MARKET_QUERY = q;
          subscribeEventMarkets(q);
        });

        let br = document.createElement("br");
        let options = document.createElement("td");
        options.append(
          getMarketsBtn,
          br,
          subscribeMarketsBtn,
          br,
          showRawJsonBtn
        );

        let tableRow = document.createElement("tr");

        tableRow.append(
          info,
          eventId,
          status,
          gameInfo,
          queryTimeInfo,
          responseTimeInfo,
          options
        );

        return tableRow;
      }

      // </editor-fold>

      // <editor-fold defaultstate="collapsed" desc="markets">

      async function refreshMarkets() {
        let query = getMarketQueryStr();
        let marketsResponse = await getMarkets(query);
        let markets = marketsResponse.markets;
        displayMarkets(markets);
      }

      async function refreshEventMarkets(query) {
        CURRENT_MARKET_QUERY = query;
        let marketsResponse = await getMarkets(query);
        let markets = marketsResponse.markets;
        displayEventMarkets(markets);
      }

      async function refreshOutrights() {
        let query = getOutrightQueryStr();
        let outrightResponse = await getOutrights(query);
        let outrights = outrightResponse.outrights;
        displayOutrights(outrights);
      }

      async function refreshSports() {
        let query = getSportQueryStr();
        let sportResponse = await getSports(query);
        let sports = sportResponse.sports;
        displaySports(sports);
      }

      async function refreshLeagues() {
        let query = getLeagueQueryStr();
        let sportResponse = await getLeagues(query);
        let leagues = sportResponse.leagues;
        displayLeagues(leagues);
      }

      function subscribeEventMarkets(query) {
        clearSource();

        // let url = `/stream/v1/GetMarkets?${query}`;
        let token = document.getElementById("token").value;

        let url = `/sports/stream/v1/GetMarkets?token=${token}`;
        if (query !== "") {
          url = `${url}&${query}`;
        }

        let u = createFullUrl(url);
        CURRENT_SOURCE = new EventSource(u);

        CURRENT_SOURCE.onmessage = mergeEventMarketDiffs;

        document.getElementById("market_popup_disconnect_btn").disabled = false;
      }

      function mergeEventDiffs(sseEvent) {
        let data = JSON.parse(sseEvent.data);

        console.log(JSON.stringify(data, null, 2));

        let status = data.status;

        let events = data.payload.events;

        if (status === 1) {
          CURRENT_STATE = events["add"];
        } else if (status === 0) {
          let add = events["add"];
          let changes = events["change"];
          let remove = events["remove"];

          CURRENT_STATE = CURRENT_STATE.filter(
            (e) => !remove.includes(e.eventId)
          );

          CURRENT_STATE = CURRENT_STATE.concat(add);

          let changeMap = new Map(changes.map((obj) => [obj.eventId, obj]));

          for (let i = 0; i < CURRENT_STATE.length; ++i) {
            let e = CURRENT_STATE[i];
            let eventId = e.eventId;

            if (changeMap.has(eventId)) {
              let change = changeMap.get(eventId);

              e.eventStatus = change.eventStatus;
              e.globalShowTime = change.globalShowTime;
              e.hasLiveMarket = change.hasLiveMarket;
              e.marketCount = change.marketCount;
              e.marketCategories = change.marketCategories;

              e.gameInfo.livePeriod = change.gameInfo.livePeriod;
              e.gameInfo.seconds = change.gameInfo.seconds;
              e.gameInfo.isNeutral = change.gameInfo.isNeutral;
              e.gameInfo.isHt = change.gameInfo.isHt;
              e.gameInfo.isBreak = change.gameInfo.isBreak;
              e.gameInfo.isClosed = change.gameInfo.isClosed;
              e.gameInfo.inJuryTime = change.gameInfo.inJuryTime;
              e.gameInfo.delayLive = change.gameInfo.delayLive;
              e.gameInfo.gameStatus = change.gameInfo.gameStatus;
              e.gameInfo.inPlayTime = change.gameInfo.inPlayTime;
              e.gameInfo.liveHomeScore = change.gameInfo.liveHomeScore;
              e.gameInfo.liveAwayScore = change.gameInfo.liveAwayScore;

              if (e.hasOwnProperty("soccerInfo"))
                e.soccerInfo = change.soccerInfo;

              if (e.hasOwnProperty("tennisInfo"))
                e.tennisInfo = change.tennisInfo;

              if (e.hasOwnProperty("beachVolleyBallInfo"))
                e.beachVolleyBallInfo = change.beachVollyBallInfo;

              if (e.hasOwnProperty("eSportInfo"))
                e.eSportInfo = change.eSportInfo;
            }
          }
        }

        let currentEvent = {
          events: CURRENT_STATE,
          queryTime: data.queryTime,
          responseTime: data.responseTime,
        };
        displayEventSse(currentEvent);
      }

      function mergeMarketDiffs(sseEvent) {
        let data = JSON.parse(sseEvent.data);

        console.log(JSON.stringify(data, null, 2));

        let status = data.status;

        let markets = data.payload.markets;

        if (status === 1) {
          CURRENT_STATE = markets["add"];
        } else if (status === 0) {
          let add = markets["add"];
          let changes = markets["change"];
          let remove = markets["remove"];

          CURRENT_STATE = CURRENT_STATE.filter(
            (m) => !remove.includes(m.marketId)
          );

          CURRENT_STATE = CURRENT_STATE.concat(add);

          let changeMap = new Map(changes.map((obj) => [obj.marketId, obj]));

          for (let i = 0; i < CURRENT_STATE.length; ++i) {
            let m = CURRENT_STATE[i];
            let marketId = m.marketId;

            if (changeMap.has(marketId)) {
              let change = changeMap.get(marketId);

              m.isLive = change.isLive;
              m.marketStatus = change.marketStatus;

              let map = new Map(change.selections.map((obj) => [obj.key, obj]));

              for (let k = 0; k < m.selections.length; ++k) {
                let s = m.selections[k];
                let c = map.get(s.key);
                s.point = c.point;
                s.point2 = c.point2;
                s.oddsPrice.parlayPrice = c.oddsPrice.parlayPrice;
                s.oddsPrice.malayPrice = c.oddsPrice.malayPrice;
                s.oddsPrice.decimalPrice = c.oddsPrice.decimalPrice;
                s.oddsPrice.hongKongPrice = c.oddsPrice.hongKongPrice;
                s.oddsPrice.indoPrice = c.oddsPrice.indoPrice;
                s.oddsPrice.americanPrice = c.oddsPrice.americanPrice;
              }
            }
          }
        }

        displayMarkets(CURRENT_STATE);
      }

      function mergeEventMarketDiffs(sseEvent) {
        let data = JSON.parse(sseEvent.data);

        console.log(JSON.stringify(data, null, 2));

        let status = data.status;

        let markets = data.payload.markets;

        if (status === 1) {
          CURRENT_STATE = markets["add"];
        } else if (status === 0) {
          let add = markets["add"];
          let changes = markets["change"];
          let remove = markets["remove"];

          CURRENT_STATE = CURRENT_STATE.filter(
            (m) => !remove.includes(m.marketId)
          );

          CURRENT_STATE = CURRENT_STATE.concat(add);

          let changeMap = new Map(changes.map((obj) => [obj.marketId, obj]));

          for (let i = 0; i < CURRENT_STATE.length; ++i) {
            let m = CURRENT_STATE[i];
            let marketId = m.marketId;

            if (changeMap.has(marketId)) {
              let change = changeMap.get(marketId);

              m.isLive = change.isLive;
              m.marketStatus = change.marketStatus;

              let map = new Map(change.selections.map((obj) => [obj.key, obj]));

              for (let k = 0; k < m.selections.length; ++k) {
                let s = m.selections[k];
                let c = map.get(s.key);
                s.point = c.point;
                s.point2 = c.point2;
                s.oddsPrice.parlayPrice = c.oddsPrice.parlayPrice;
                s.oddsPrice.malayPrice = c.oddsPrice.malayPrice;
                s.oddsPrice.decimalPrice = c.oddsPrice.decimalPrice;
                s.oddsPrice.hongKongPrice = c.oddsPrice.hongKongPrice;
                s.oddsPrice.indoPrice = c.oddsPrice.indoPrice;
                s.oddsPrice.americanPrice = c.oddsPrice.americanPrice;
              }
            }
          }
        }

        displayEventMarkets(CURRENT_STATE);
      }

      function mergeOutrightDiffs(sseEvent) {
        let data = JSON.parse(sseEvent.data);

        console.log(JSON.stringify(data, null, 2));

        let status = data.status;

        let outrights = data.payload.outrights;

        if (status === 1) {
          CURRENT_STATE = outrights["add"];
        } else if (status === 0) {
          let add = outrights["add"];
          let changes = outrights["change"];
          let remove = outrights["remove"];

          CURRENT_STATE = CURRENT_STATE.filter(
            (m) => !remove.includes(m.leagueId)
          );

          CURRENT_STATE = CURRENT_STATE.concat(add);

          let changeMap = new Map(changes.map((obj) => [obj.leagueId, obj]));

          for (let i = 0; i < CURRENT_STATE.length; ++i) {
            let o = CURRENT_STATE[i];
            let leagueId = o.leagueId;

            if (changeMap.has(leagueId)) {
              let change = changeMap.get(leagueId);

              o.eventStatus = change.eventStatus;

              let map = new Map(change.teams.map((obj) => [obj.orid, obj]));

              for (let k = 0; k < o.teams.length; ++k) {
                let s = o.teams[k];
                let c = map.get(s.orid);
                s.price = c.price;
                s.maxBet = c.maxBet;
                s.oddsStatus = c.oddsStatus;
                s.isUpdate = c.isUpdate;
              }
            }
          }
        }

        displayOutrights(CURRENT_STATE);
      }

      function mergeSportsDiffs(sseEvent) {
        let data = JSON.parse(sseEvent.data);

        console.log(JSON.stringify(data, null, 2));

        let status = data.status;

        let sports = data.payload.sports;

        if (status === 1) {
          CURRENT_STATE = sports["add"];
        } else if (status === 0) {
          let add = sports["add"];
          let changes = sports["change"];
          let remove = sports["remove"];

          CURRENT_STATE = CURRENT_STATE.filter(
            (s) => !remove.includes(s.sportType)
          );

          CURRENT_STATE = CURRENT_STATE.concat(add);

          let changeMap = new Map(changes.map((obj) => [obj.sportType, obj]));

          for (let i = 0; i < CURRENT_STATE.length; ++i) {
            let s = CURRENT_STATE[i];
            let sportType = s.sportType;

            if (changeMap.has(sportType)) {
              let change = changeMap.get(sportType);
              s.gameCount = change.gameCount;
              s.liveGameCount = change.liveGameCount;
              s.outrightGame = change.outrightGame;
              s.parlayGame = change.parlayGame;
            }
          }
        }

        displaySports(CURRENT_STATE);
      }

      function mergeLeaguesDiffs(sseEvent) {
        let data = JSON.parse(sseEvent.data);

        console.log(JSON.stringify(data, null, 2));

        let status = data.status;

        let leagues = data.payload.leagues;

        if (status === 1) {
          CURRENT_STATE = leagues["add"];
        } else if (status === 0) {
          let add = leagues["add"];
          let changes = leagues["change"];
          let remove = leagues["remove"];

          CURRENT_STATE = CURRENT_STATE.filter(
            (l) => !(remove.includes(l.leagueId) && remove.includes(l.isParlay))
          );

          CURRENT_STATE = CURRENT_STATE.concat(add);

          let changeMap = new Map(
            changes.map((obj) => [`${obj.leagueid}_${obj.isParlay}`, obj])
          );

          for (let i = 0; i < CURRENT_STATE.length; ++i) {
            let l = CURRENT_STATE[i];
            let leagueKey = `${l.leagueid}_${l.isParlay}`;

            if (changeMap.has(leagueKey)) {
              let change = changeMap.get(leagueKey);
              l.gameCount = change.gameCount;
              l.liveGameCount = change.liveGameCount;
            }
          }
        }

        displayLeagues(CURRENT_STATE);
      }

      function displayMarkets(markets) {
        let marketsTable = document.getElementById("table");
        marketsTable.innerHTML = "";
        marketsTable.append(getMarketsTableHeaders());
        markets.forEach((m) => {
          marketsTable.append(createMarketRow(m));
        });
        createTotalTable();
      }

      function displayEventMarkets(markets) {
        let popupContent = document.getElementById("market_popup_content");
        popupContent.innerHTML = "";
        popupContent.append(createEventMarketsTable(markets));
        document.getElementById("market_popup").style.display = "block";
        createTotalTable();
      }

      function displayOutrights(outright) {
        let outrightTable = document.getElementById("table");
        outrightTable.innerHTML = "";
        outrightTable.append(getOutrightsTableHeaders());
        outright.forEach((o) => {
          outrightTable.append(createOutrightRow(o));
        });
        createTotalTable();
      }

      function displaySports(sports) {
        let sportTable = document.getElementById("table");
        sportTable.innerHTML = "";
        sportTable.append(getSportsTableHeaders());
        sports.forEach((o) => {
          sportTable.append(createSportRow(o));
        });
        createTotalTable();
      }

      function displayLeagues(leagues) {
        let leagueTable = document.getElementById("table");
        leagueTable.innerHTML = "";
        leagueTable.append(getLeaguesTableHeaders());
        leagues.forEach((o) => {
          leagueTable.append(createLeagueRow(o));
        });
        createTotalTable();
      }

      function getMarketsTableHeaders() {
        let sportTypeTh = document.createElement("th");
        sportTypeTh.innerText = "SportType";
        let eventIdTh = document.createElement("th");
        eventIdTh.innerText = "EventId";
        let marketIdTh = document.createElement("th");
        marketIdTh.innerText = "MarketId";
        let betTypeTh = document.createElement("th");
        betTypeTh.innerText = "BetType";
        let statusTh = document.createElement("th");
        statusTh.innerText = "Status";
        let selectionsTh = document.createElement("th");

        selectionsTh.innerText = "Selections";
        let tr = document.createElement("tr");
        tr.append(
          sportTypeTh,
          eventIdTh,
          marketIdTh,
          betTypeTh,
          statusTh,
          selectionsTh
        );
        return tr;
      }

      function getEventMarketsTableHeaders() {
        let marketIdTh = document.createElement("th");
        marketIdTh.innerText = "MarketId";
        let betTypeTh = document.createElement("th");
        betTypeTh.innerText = "BetType";
        let statusTh = document.createElement("th");
        statusTh.innerText = "Status";
        let selectionsTh = document.createElement("th");

        selectionsTh.innerText = "Selections";
        let tr = document.createElement("tr");
        tr.append(marketIdTh, betTypeTh, statusTh, selectionsTh);
        return tr;
      }

      function getOutrightsTableHeaders() {
        let infoTh = document.createElement("th");
        infoTh.innerText = "Info";
        let leagueIdTh = document.createElement("th");
        leagueIdTh.innerText = "LeagueId";
        let statusTh = document.createElement("th");
        statusTh.innerText = "Status";
        let teamsTh = document.createElement("th");
        teamsTh.innerText = "Teams";
        let tr = document.createElement("tr");
        tr.append(infoTh, leagueIdTh, statusTh, teamsTh);
        return tr;
      }

      function getSportsTableHeaders() {
        let sportTypeTh = document.createElement("th");
        sportTypeTh.innerText = "Sport";
        let sportNameTh = document.createElement("th");
        sportNameTh.innerText = "SportName";
        let gameCountTh = document.createElement("th");
        gameCountTh.innerText = "GameCount";
        let liveGameCountTh = document.createElement("th");
        liveGameCountTh.innerText = "LiveGameCount";
        let outrightGameTh = document.createElement("th");
        outrightGameTh.innerText = "OutrightGame";
        let parlayGameTh = document.createElement("th");
        parlayGameTh.innerText = "ParlayGame";
        let tr = document.createElement("tr");
        tr.append(
          sportTypeTh,
          sportNameTh,
          gameCountTh,
          liveGameCountTh,
          outrightGameTh,
          parlayGameTh
        );
        return tr;
      }

      function getLeaguesTableHeaders() {
        let sportTypeTh = document.createElement("th");
        sportTypeTh.innerText = "Sport";
        let leagueTh = document.createElement("th");
        leagueTh.innerText = "League";
        let gameCountTh = document.createElement("th");
        gameCountTh.innerText = "GameCount";
        let liveGameCountTh = document.createElement("th");
        liveGameCountTh.innerText = "LiveGameCount";

        let tr = document.createElement("tr");
        tr.append(sportTypeTh, leagueTh, gameCountTh, liveGameCountTh);
        return tr;
      }

      function createEventMarketsTable(markets) {
        let marketsTable = document.createElement("table");
        marketsTable.id = "markets_table";
        marketsTable.append(getEventMarketsTableHeaders());

        markets.forEach((m) => {
          marketsTable.append(createEventMarketRow(m));
        });

        return marketsTable;
      }

      function createSportsTable(markets) {
        let sportTable = document.createElement("table");
        sportTable.id = "sports_table";
        sportTable.append(getSportsTableHeaders());

        markets.forEach((o) => {
          sportTable.append(createSportRow(o));
        });

        return sportTable;
      }

      function createLeaguesTable(markets) {
        let leagueTable = document.createElement("table");
        leagueTable.id = "leagues_table";
        leagueTable.append(getLeaguesTableHeaders());

        markets.forEach((o) => {
          leagueTable.append(createLeagueRow(o));
        });

        return leagueTable;
      }

      function createMarketRow(m) {
        let sportTypeTd = document.createElement("td");
        sportTypeTd.innerText = m.sportType;
        let eventIdTd = document.createElement("td");
        eventIdTd.innerText = m.eventId;
        let marketId = document.createElement("td");
        marketId.innerText = m.marketId;

        let betType = document.createElement("td");
        betType.innerText = `${m.betType} - ${m.betTypeName}`;

        let status = document.createElement("td");
        status.innerText = m.marketStatus;

        let selections = document.createElement("td");
        selections.append(createSelectionsTable(m));

        let tr = document.createElement("tr");
        tr.append(
          sportTypeTd,
          eventIdTd,
          marketId,
          betType,
          status,
          selections
        );

        return tr;
      }

      function createEventMarketRow(m) {
        let marketId = document.createElement("td");
        marketId.innerText = m.marketId;

        let betType = document.createElement("td");
        betType.innerText = `${m.betType} - ${m.betTypeName}`;

        let status = document.createElement("td");
        status.innerText = m.marketStatus;

        let selections = document.createElement("td");
        selections.append(createSelectionsTable(m));

        let tr = document.createElement("tr");
        tr.append(marketId, betType, status, selections);

        return tr;
      }

      function createOutrightRow(o) {
        let infoTd = document.createElement("td");
        infoTd.innerText = `${o.sportName}\n${o.leagueName}\n${o.eventDate}`;
        let leagueIdTd = document.createElement("td");
        leagueIdTd.innerText = o.leagueId;
        let status = document.createElement("td");
        status.innerText = o.eventStatus;

        let teams = document.createElement("td");
        teams.append(createTeamsTable(o));

        let tr = document.createElement("tr");
        tr.append(infoTd, leagueIdTd, leagueIdTd, status, teams);

        return tr;
      }

      function createSportRow(s) {
        let sportTypeTd = document.createElement("td");
        sportTypeTd.innerText = s.sportType;
        let sportNameTd = document.createElement("td");
        sportNameTd.innerText = s.sportName;
        let gameCountTd = document.createElement("td");
        gameCountTd.innerText = s.gameCount;
        let liveGameCountTd = document.createElement("td");
        liveGameCountTd.innerText = s.liveGameCount;
        let outrightGameTd = document.createElement("td");
        outrightGameTd.innerText = s.outrightGame;
        let parlayGameTd = document.createElement("td");
        parlayGameTd.innerText = s.parlayGame;
        let tr = document.createElement("tr");
        tr.append(
          sportTypeTd,
          sportNameTd,
          gameCountTd,
          gameCountTd,
          liveGameCountTd,
          outrightGameTd,
          parlayGameTd
        );

        return tr;
      }

      function createLeagueRow(l) {
        let sportTypeTd = document.createElement("td");
        sportTypeTd.innerText = `${l.sportType}\n${l.sportName}`;
        let leagueTd = document.createElement("td");
        leagueTd.innerText = `${l.leagueId}\n${l.leagueName}`;
        let gameCountTd = document.createElement("td");
        gameCountTd.innerText = l.gameCount;
        let liveGameCountTd = document.createElement("td");
        liveGameCountTd.innerText = l.liveGameCount;

        let tr = document.createElement("tr");
        tr.append(sportTypeTd, leagueTd, gameCountTd, liveGameCountTd);

        return tr;
      }

      function createSelectionsTable(market) {
        let selectionsTable = document.createElement("table");
        let keyTh = document.createElement("th");
        keyTh.innerText = "Key";
        let keyNameTh = document.createElement("th");
        keyNameTh.innerText = "Name";
        let pointTh = document.createElement("th");
        pointTh.innerText = "Point";
        let decOddsTh = document.createElement("th");
        decOddsTh.innerText = "DecOdds";
        selectionsTable.append(keyTh, keyNameTh, pointTh, decOddsTh);

        let selections = market.selections;
        selections.forEach((s) => {
          let key = document.createElement("td");
          key.innerText = s.key;
          let keyName = document.createElement("td");
          keyName.innerText = s.keyName;
          let point = document.createElement("td");
          point.innerText = s.point;
          let decOdds = document.createElement("td");
          // decOdds.innerText = s.oddsPrice.decimalPrice;
          decOdds.innerText = s.oddsPrice.malayPrice;

          let selection = document.createElement("tr");
          selection.append(key, keyName, point, decOdds);
          selectionsTable.append(selection);
        });

        return selectionsTable;
      }

      function createTeamsTable(outright) {
        let teamsTable = document.createElement("table");
        let oridTh = document.createElement("th");
        oridTh.innerText = "Orid";
        let teamTh = document.createElement("th");
        teamTh.innerText = "Team";
        let priceTh = document.createElement("th");
        priceTh.innerText = "Price";
        let maxBetTh = document.createElement("th");
        maxBetTh.innerText = "MaxBet";
        let oddsStatus = document.createElement("th");
        oddsStatus.innerText = "OddsStatus";
        teamsTable.append(oridTh, teamTh, priceTh, maxBetTh, oddsStatus);

        let teams = outright.teams;
        teams.forEach((s) => {
          let orid = document.createElement("td");
          orid.innerText = s.orid;
          let teamName = document.createElement("td");
          teamName.innerText = s.teamName;
          let price = document.createElement("td");
          price.innerText = s.price;
          let maxBet = document.createElement("td");
          maxBet.innerText = s.maxBet;
          let oddsStatus = document.createElement("td");
          oddsStatus.innerText = s.oddsStatus;
          let team = document.createElement("tr");
          team.append(orid, teamName, price, maxBet, oddsStatus);
          teamsTable.append(team);
        });

        return teamsTable;
      }

      // </editor-fold>

      // <editor-fold defaultstate="collapsed" desc="code for api calls">
      async function getEvents(query) {
        let url = `/sports/v1/GetEvents?${query}`;
        return await apiGet(url);
      }

      async function getMarkets(query) {
        let url = `/sports/v1/GetMarkets?${query}`;
        return await apiGet(url);
      }

      async function getOutrights(query) {
        let url = `/sports/v1/GetOutrights?${query}`;
        return await apiGet(url);
      }

      async function getSports(query) {
        let url = `/sports/v1/GetSports?${query}`;
        return await apiGet(url);
      }

      async function getLeagues(query) {
        let url = `/sports/v1/GetLeagues?${query}`;
        return await apiGet(url);
      }

      async function apiGet(url) {
        return await apiRequest("GET", url, null);
      }

      async function apiRequest(method, url, body) {
        let fullUrl = createFullUrl(url);
        let token = document.getElementById("token").value;
        let reqHeaders = {
          Accept: "application/json",
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };
        let response = await fetch(fullUrl, {
          method: method,
          headers: reqHeaders,
          body:
            body === undefined || body == null ? null : JSON.stringify(body),
        });
        let message = `${method} ${fullUrl} response.status: ${response.status}`;
        console.log(message);

        if (!response.ok) {
          notify(message);
        }
        return await response.json();
      }

      async function getToken() {
        let fullUrl = createFullUrl("/login");
        let reqHeaders = {
          Accept: "application/json",
          "Content-Type": "application/json",
        };

        let response = await fetch(fullUrl, {
          method: "POST",
          headers: reqHeaders,
          body: JSON.stringify(getLicensee()),
        });
        let message = `'Post' ${fullUrl} response.status: ${response.status}`;
        console.log(message);

        if (!response.ok) {
          notify(message);
        }
        document.getElementById("token").value = (await response.json()).access_token;
        document.getElementById("display_token").innerText =
          "Get Token Success!";
      }

      // </editor-fold>

      function createFullUrl(url) {
        let radioBtns = document.querySelectorAll("[id^=r_e_]");
        let domain = "";
        radioBtns.forEach((element) => {
          if (element.checked) {
            switch (element.id) {
              case "r_e_staging":
                domain = "https://apistaging.wx7777.com";
                break;
              case "r_e_production":
                domain = "https://api.wx7777.com";
                break;
            }
          }
        });
        return `${domain}${url}`;
      }

      function getLicensee() {
        return {
          Vendor_ID: document.getElementById("r_e_vendor_id").value,
          Vendor_Member_ID: document.getElementById("r_e_vendor_member_id").value,
        };
      }

      function notify(message) {
        alert(message);
      }

      function changeEnvironmentArea(eleId) {
        let radioBtns = document.querySelectorAll("[id^=r_e_]");
        radioBtns.forEach((element) => {
          element.checked = element.id === eleId;
        });
        document.getElementById("table").innerHTML = "";
        document.getElementById("total_table").innerHTML = "";
        document.getElementById("token").value = "";
        document.getElementById("display_token").innerText = "";

        if (CURRENT_SOURCE != null) {
          CURRENT_SOURCE.close();
        }
      }

      function changeApiArea(eleId) {
        let radioBtns = document.querySelectorAll("[id^=r_t_]");
        radioBtns.forEach((element) => {
          element.checked = element.id === eleId;
          document.getElementById("Sse_Event").style.display = "none";
        });

        document.getElementById("Sse_Event").style.display = "none";
        document.getElementById("Sse_Market").style.display = "none";
        document.getElementById("Sse_Outright").style.display = "none";
        document.getElementById("Sse_Sport").style.display = "none";
        document.getElementById("Sse_League").style.display = "none";
        switch (eleId) {
          case "r_t_event":
            document.getElementById("Sse_Event").style.display = "";
            break;
          case "r_t_market":
            document.getElementById("Sse_Market").style.display = "";
            break;
          case "r_t_outright":
            document.getElementById("Sse_Outright").style.display = "";
            break;
          case "r_t_sport":
            document.getElementById("Sse_Sport").style.display = "";
            break;
          case "r_t_league":
            document.getElementById("Sse_League").style.display = "";
        }
        document.getElementById("table").innerHTML = "";
        document.getElementById("total_table").innerHTML = "";
        if (CURRENT_SOURCE != null) {
          CURRENT_SOURCE.close();
        }
      }
    </script>
  </body>
</html>
